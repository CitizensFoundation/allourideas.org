!!! 5
%html
  %head
    %title= t('common.title')
    = stylesheet_link_tag 'http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css'
    = javascript_include_tag 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'
    :javascript 
      var AUTH_TOKEN = #{form_authenticity_token.inspect};
      var PAGE_LOADED_AT = new Date();
      var RAILS_LOCALE = '#{I18n.locale}';
    
    :css
      body {
        margin-top: 10px;
      }

      div#header {
        opacity: 0.4;
      }
      
      div#header:hover {
        opacity: 1.0;
      }

      ul.nav {
        float: right;
      }

      ul.nav a:hover {
        color: #0069D6;
        text-decoration: underline;
      }

      h2.question {
        text-align: center;
        margin-bottom: 35px;
      }

      div.ad {
        height: 172px;
        border: 1px solid silver;
        background: url(#{image_path('wikipedia/ad/1.png')}) no-repeat;
        margin-bottom: 35px;
      }

      div.ad:hover {
        background: #eee url(#{image_path('wikipedia/ad/1.png')}) no-repeat;
        cursor: pointer;
      }

      div.ad .copy {
        text-align: center;
        color: navy;
        font-family: Helvetica, Arial, sans-serif;
        font-size: 29px;
        font-weight: bold;
        height: 84px;
        line-height: 28px;
        margin: 0;
        padding-bottom: 23px;
        padding-left: 210px;
        padding-right: 80px;
        padding-top: 43px;
      }

      div#vote-footer {
        text-align: center;
        margin-bottom: 35px;
      }

      div.row.bottom {
        margin-bottom: 35px;
      }

    :javascript
      $(document).ready(function() {
        // voting
        $('.vote').live('click', function(e) {
      		if ($(this).hasClass('loading')) {
      			alert("One sec, we're loading the next pair...");
      		} else {
            // visible if the users hasn't voted
      			$('.click_to_vote').hide();

      			$(this).addClass('checked');

            // prevent double clicking
      			$('.vote').addClass('loading');

      			castVote($(this));
      		}
      		e.preventDefault();
        });
      });


      function castVote(choice) {
      	var VOTE_CAST_AT = new Date();

      	jQuery.ajax({
      		type: 'POST',
      		dataType: 'json',
      	  url: choice.attr('href'),
      	  data: {
      	  	authenticity_token: encodeURIComponent(AUTH_TOKEN),
      			time_viewed: VOTE_CAST_AT - PAGE_LOADED_AT,
      	    appearance_lookup: $('#appearance_lookup').val()
      	  },
      	  error: function(request, textStatus, errorThrown) {
      			voteError(request, textStatus, errorThrown);
      		},
      	  success: function(data, textStatus, request) {
            // the ordering of these functions is important
            // because some rely on attrs of the a.vote
            // and others modify those attrs
      			loadNextPrompt(data);
      			updateUrlsAndHiddenFields(data);
      			$('.vote').removeClass('loading'); 
      			choice.removeClass('checked');
      			PAGE_LOADED_AT = new Date(); // reset the page load time
      		}
      	});
      };

      function loadNextPrompt(data) {
      	jQuery.each(['left', 'right'], function(index, side) {
      		var current_ad = $('.vote.' + side + ' > .copy');

          // change photos
      		current_ad.html(data['new' + side]);

          // allow voting after fully faded in
          $('.vote.' + side).removeClass('loading');
      	});
      }

      function updateUrlsAndHiddenFields(data) {
      	jQuery.each(['left', 'right'], function(index, side) {
          // change href url
      		$('a.vote.' + side).attr('href', data['new' + side + '_url']);
          // change choice url
      		$('a.vote.' + side).attr('choice_url', data['new' + side + '_choice_url']);
      	});

        // change appearance_lookup and prompt_id hidden fields
      	$('#appearance_lookup').val(data['appearance_lookup']);
      	$('#prompt_id').val(data['prompt_id']);

        // change urls for inappropriate and skip forms
      	$('#flag_as_inappropriate_form').attr('action', data['flag_url']);
      	$('#cant_decide_form').attr('action', data['skip_url']);
      }

  %body
    =hidden_field_tag 'appearance_lookup', @question.attributes['appearance_id']
    =hidden_field_tag 'prompt_id', @prompt.id
    .container
      .row
        #header.page-header
          =link_to image_tag('wikipedia/hearts_wikipedia.png'), root_url
      
          %ul.nav
            %li= link_to t('vote.cast_votes'), @cast_votes_url
            %li= link_to t('nav.view_results'), @results_url
            %li= link_to t('nav.about_this_page'), @about_url

      .row
        %h2.question= @question.name
        .ad.vote{:href => vote_question_prompt_url(@question.id, @prompt.id, :direction => 'left'), 
          :choice_url => url_for(:action => :show, :controller => :choices, :id => @left_choice_id, :question_id => params[:id]), 
          :direction => 'left', 
          :id => 'leftside'}
          .copy
            =truncate(h(@left_choice_text), :length => 137)

        .ad.vote{:href => vote_question_prompt_url(@question.id, @prompt.id, :direction => 'right'), 
            :choice_url => url_for(:action => :show, :controller => :choices, :id => @left_choice_id, :question_id => params[:id]), 
            :direction => 'right', 
            :id => 'rightside'}
          .copy
            =truncate(h(@right_choice_text), :length => 137)

      #vote-footer.row
        %p= link_to "I can't decide"
        %p=link_to_function "Add your own idea", "", :class => 'btn success'

      .row.bottom
        %h3 The encyclopedia fundraiser than anyone can edit
        %p
          Wikipedia is looking for a better banner text, and they want your help.  Only about one in a thousand Wikipedia users donate, but we think we can improve that -- by finding better text for the banners.  For a given picture, you will see two possible banner texts.  Please click on the one that makes you want to donate more.  If you have a suggestion for better text, please upload it.  Some of the best ideas will appear on real banners during the fundraiser.  This is the encyclopedia fundraiser anyone can edit.

      .row.bottom
        %h3 FAQ
        %p
          How can I donate to Wikimedia Foundation, the parent organization of Wikipedia?

          You can donate here.
          What does Wikipedia and the Wikimedia Foundation do with the donations?

          Good stuff.  The two biggest expenses are technology and people.  You can read more about this in their financial reports.
          Why do I always see the same picture on both banners?

          We are trying to find the best banner text to go with each picture.  This head-to-head comparison is the best way to do it.
          Can I suggest a new image for a banner?

          Sure, you can suggest any image from Wikimedia Commons.  Please email us a link to the image (info@allourideas.org) and we will review it.